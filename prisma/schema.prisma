generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// role management
enum RoleType {
  SYSTEM_ADMIN // Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng
  SELLER
  CUSTOMER
  GUEST
  KYC_REVIEWER // Ng∆∞·ªùi duy·ªát KYC
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  type        RoleType @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([type])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("roles")
}

enum PermissionModule {
  USER_MANAGEMENT
  SHOP_MANAGEMENT
  PRODUCT_MANAGEMENT
  ORDER_MANAGEMENT
  CART_MANAGEMENT
  KYC_MANAGEMENT
  CATEGORY_MANAGEMENT
  SYSTEM_SETTINGS
  REPORTS_ANALYTICS
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  REJECT
  EXPORT
  IMPORT
  ASSIGN
  REVOKE
}

model Permission {
  id          String           @id @default(uuid())
  module      PermissionModule
  action      PermissionAction
  description String?
  isActive    Boolean          @default(true) @map("is_active")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@unique([module, action])
  @@index([module])
  @@index([action])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@index([createdAt])
  @@map("role_permissions")
}

model UserRole {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  roleId    String    @map("role_id")
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at") // Role c√≥ th·ªÉ c√≥ th·ªùi h·∫°n

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  role          Role           @relation(fields: [roleId], references: [id], onDelete: Cascade)
  voucherUsages VoucherUsage[]

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@index([isActive])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("user_roles")
}

model UserPermission {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  permissionId String    @map("permission_id")
  isGranted    Boolean   @default(true) @map("is_granted") // true = grant, false = deny
  expiresAt    DateTime? @map("expires_at")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([isGranted])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("user_permissions")
}

model UserActivity {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  action      String // CREATE_PRODUCT, UPDATE_SHOP, DELETE_USER, etc.
  module      String // PRODUCT, SHOP, USER, etc.
  resourceId  String?  @map("resource_id") // ID c·ªßa t√†i nguy√™n b·ªã t√°c ƒë·ªông
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  metadata    Json? // Th√¥ng tin b·ªï sung
  performedAt DateTime @default(now()) @map("performed_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([resourceId])
  @@index([performedAt])
  @@map("user_activities")
}

// User management
enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
  BANNED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

model User {
  // Primary fields
  id           String  @id @default(uuid())
  email        String  @unique
  password     String
  identityCard String? @unique

  // Personal information
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  phoneNumber String?   @unique @map("phone_number")
  address     String?
  birthday    DateTime?
  gender      Gender?
  avatarUrl   String?   @map("avatar_url")

  // Status and verification
  status          UserStatus @default(PENDING)
  emailVerified   Boolean    @default(false) @map("email_verified")
  emailVerifiedAt DateTime?  @map("email_verified_at")

  // Security fields
  lastLoginAt          DateTime? @map("last_login_at")
  passwordResetToken   String?   @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")

  // Blockchain wallet info
  walletAddress    String? @map("wallet_address")
  preferredNetwork String? @default("BSC") @map("preferred_network") // BSC, ETH, POLYGON

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // relation
  shop                     Shop?                     @relation("ShopOwner")
  cart                     Cart?
  approvedShops            Shop[]                    @relation("ShopApprover")
  reviewedKycs             KycData[]                 @relation("KycReviewer")
  kycData                  KycData[]
  roles                    UserRole[]
  permissions              UserPermission[]
  activities               UserActivity[]
  orders                   Order[]
  cashbacks                Cashback[]
  conversationParticipants ConversationParticipant[]
  messages                 Message[]
  voucherUsages            VoucherUsage[]

  @@index([email])
  @@index([status])
  @@index([emailVerified])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([phoneNumber])
  @@index([firstName, lastName])
  @@map("users")
}

enum KycStatus {
  INCOMPLETE
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum DocumentType {
  IDENTITY_CARD
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
}

// Shop Management
enum ShopStatus {
  DRAFT
  ACTIVE
  INACTIVE
  SUSPENDED
  CLOSED
}

enum ApprovalStatus {
  PENDING_APPROVAL
  PENDING_KYC
  APPROVED
  REJECTED
  REVIEWING
  REQUIRES_DOCUMENTS
}

model Shop {
  // Primary fields
  id          String     @id @default(uuid())
  ownerId     String     @unique @map("owner_id")
  name        String     @unique
  status      ShopStatus @default(INACTIVE)
  logoUrl     String?    @map("logo_url")
  email       String?    @unique @map("email")
  phoneNumber String?    @unique @map("phone_number")

  // Address fields 
  street   String?
  ward     String?
  district String?
  city     String?
  country  String  @default("Vi·ªát Nam")

  // Business config
  category   String? // b√°n g√¨ ? Qu·∫ßn √°o, gi√†y d√©p, c√¥ng ngh·ªá...
  isVerified Boolean   @default(false) @map("is_verified") // gi·ªëng shopee mall √°
  verifiedAt DateTime? @map("verified_at")

  //operation
  autoApprove Boolean @default(false) @map("auto_approve") // tu xac nhan don hang

  // Approval
  approvalStatus  ApprovalStatus @default(PENDING_APPROVAL) @map("approval_status")
  approvedBy      String?        @map("approved_by")
  approvedAt      DateTime?      @map("approved_at")
  rejectionReason String?        @map("rejection_reason")

  // bank
  bankName          String? @map("bank_name")
  bankAccount       String? @map("bank_account")
  bankAccountNumber String? @map("bank_account_number")

  // statistic
  totalRevenue Decimal  @default(0) @map("total_revenue") @db.Decimal(15, 2)
  totalOrders  Int      @default(0) @map("total_orders")
  rating       Decimal? @db.Decimal(3, 2) // trung b√¨nh t·ª´ sp trong shop
  reviewCount  Int      @default(0) @map("review_count")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  approver User? @relation("ShopApprover", fields: [approvedBy], references: [id])

  currentKycId String?  @unique @map("current_kyc_id")
  currentKyc   KycData? @relation("CurrentKyc", fields: [currentKycId], references: [id])

  // Relations
  owner         User           @relation("ShopOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  products      Product[] // 1 shop c√≥ nhi·ªÅu products
  kycData       KycData[]      @relation("ShopKyc")
  orders        Order[]
  conversations Conversation[]
  vouchers      Voucher[]

  @@unique([bankName, bankAccountNumber])
  @@index([ownerId])
  @@index([status])
  @@index([name])
  @@index([city])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("shops")
}

model KycData {
  id           String    @id @default(uuid())
  status       KycStatus @default(INCOMPLETE)
  submittedAt  DateTime?
  reviewedAt   DateTime?
  approvedAt   DateTime?
  rejectedAt   DateTime?
  reviewerNote String?
  expiryDate   DateTime? // Ng√†y h·∫øt h·∫°n KYC

  // nguoi gui
  fullName        String?
  birthday        DateTime?
  personalAddress String?
  personalPhone   String?
  personalEmail   String?
  identityCard    String? // S·ªë CMND/CCCD

  // shop
  shopName    String?
  taxCode     String?
  shopAddress String?
  shopPhone   String?
  shopEmail   String?
  shopRegDate DateTime? // Ng√†y ƒëƒÉng k√Ω kinh doanh

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  shopId String

  user           User          @relation(fields: [userId], references: [id])
  shop           Shop          @relation("ShopKyc", fields: [shopId], references: [id])
  currentShop    Shop?         @relation("CurrentKyc")
  reviewerUserId String?       @map("reviewer_user_id")
  reviewer       User?         @relation("KycReviewer", fields: [reviewerUserId], references: [id])
  documents      KycDocument[]
  history        KycHistory[]

  @@unique([shopId])
  @@map("kyc_data")
}

model KycDocument {
  id           String         @id @default(uuid())
  type         DocumentType
  status       DocumentStatus @default(PENDING)
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime       @default(now())
  verifiedAt   DateTime?
  rejectedAt   DateTime?
  verifierNote String? // Ghi ch√∫ c·ªßa ng∆∞·ªùi x√°c minh

  // Foreign key
  kycDataId String

  // Relations
  kycData KycData @relation(fields: [kycDataId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

model KycHistory {
  id          String     @id @default(uuid())
  action      String // CREATE, UPDATE, APPROVE, REJECT, etc.
  oldStatus   KycStatus?
  newStatus   KycStatus?
  reason      String?
  performedBy String? // ID c·ªßa ng∆∞·ªùi th·ª±c hi·ªán
  performedAt DateTime   @default(now())
  metadata    Json? // Th√¥ng tin b·ªï sung d·∫°ng JSON

  kycDataId String

  kycData KycData @relation(fields: [kycDataId], references: [id], onDelete: Cascade)

  @@map("kyc_history")
}

model KycSettings {
  id                  String   @id @default(uuid())
  requiredDocuments   String[] // Array of DocumentType
  kycExpiryDays       Int      @default(365) // KYC h·∫øt h·∫°n sau bao nhi√™u ng√†y
  autoApprovalEnabled Boolean  @default(false)
  maxFileSize         Int      @default(10485760) // 10MB in bytes
  allowedMimeTypes    String[] // ["image/jpeg", "image/png", "application/pdf"]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("kyc_settings")
}

// Product Management
enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  OUT_OF_STOCK
  DISCONTINUED
}

model Product {
  // Primary fields
  id            String        @id @default(uuid())
  shopId        String        @map("shop_id")
  name          String
  averageRating Float         @default(0) @map("average_rating")
  reviewCount   Int           @default(0) @map("review_count")
  status        ProductStatus @default(DRAFT)
  soldCount     Int            @default(0) @map("sold_count")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Product relations
  shop       Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  variants   ProductVariant[]
  images     ProductImage[]
  options    ProductOption[]
  categories ProductCategory[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([shopId])
  @@index([status])
  @@index([name])
  @@index([averageRating])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("products")
}

model ProductVariant {
  // Primary fields
  id          String        @id @default(uuid())
  productId   String        @map("product_id")
  sku         String        @unique
  name        String
  value       String
  price       Decimal       @db.Decimal(15, 2)
  currency    String        @default("VND") // For Money value object
  status      ProductStatus @default(DRAFT) @map("product_status")
  description String?
  stock       Int           @default(0)

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Product variant relations
  product      Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  images       ProductImage[]
  optionValues ProductVariantOptionValue[]
  cartItems    CartItem[]
  orderItems   OrderItem[]

  @@index([productId])
  @@index([sku])
  @@index([status])
  @@index([price])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_variants")
}

model ProductImage {
  // Primary fields
  id          String  @id @default(uuid())
  productId   String  @map("product_id")
  variantId   String? @map("variant_id")
  imageUrl    String  @map("image_url")
  isPrimary   Boolean @default(false) @map("is_primary")
  sortOrder   Int     @default(0) @map("sort_order")
  description String?

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Product image relations
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([isPrimary])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_images")
}

model ProductOption {
  // Primary fields
  id        String @id @default(uuid())
  productId String @map("product_id")
  name      String @db.Citext

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Product option relations
  product                    Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  values                     ProductOptionValue[]
  productVariantOptionValues ProductVariantOptionValue[]

  @@unique([productId, name])
  @@index([productId])
  @@index([name])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_options")
}

model ProductOptionValue {
  // Primary fields
  id              String @id @default(uuid())
  productOptionId String @map("product_option_id")
  value           String @db.Citext
  sortOrder       Int    @default(0) @map("sort_order")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Product option value relations
  productOption              ProductOption               @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  productVariantOptionValues ProductVariantOptionValue[]

  @@unique([productOptionId, value])
  @@index([productOptionId])
  @@index([sortOrder])
  @@index([value])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_option_values")
}

model ProductVariantOptionValue {
  // Primary fields
  id                   String @id @default(uuid())
  productVariantId     String @map("product_variant_id")
  productOptionId      String @map("product_option_id")
  productOptionValueId String @map("product_option_value_id")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Many-to-many relation fields
  productVariant     ProductVariant     @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productOption      ProductOption      @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  productOptionValue ProductOptionValue @relation(fields: [productOptionValueId], references: [id], onDelete: Cascade)

  @@unique([productVariantId, productOptionId])
  @@index([productVariantId])
  @@index([productOptionId])
  @@index([productOptionValueId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_variant_option_values")
}

// Category Management
model Category {
  // Primary fields
  id               String  @id @default(uuid())
  name             String
  description      String  @default("")
  parentCategoryId String? @map("parent_category_id")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Self-referencing relations
  parentCategory  Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories Category[] @relation("CategoryHierarchy")

  // Many-to-many relation with products
  products ProductCategory[]

  @@index([name])
  @@index([parentCategoryId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("categories")
}

// many to many product and category
model ProductCategory {
  // Primary fields
  id         String @id @default(uuid())
  productId  String @map("product_id")
  categoryId String @map("category_id")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedBy String?  @map("updated_by") // User ID who last updated

  // Soft delete fields
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") // User ID who deleted

  // Relations
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("product_categories")
}

model Cart {
  id        String  @id @default(uuid())
  userId    String? @map("user_id") // null cho guest user
  sessionId String? @map("session_id") // Cho guest user

  // 
  totalItems  Int     @default(0) @map("total_items")
  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(15, 2)
  currency    String  @default("VND")

  expiresAt    DateTime? @map("expires_at") // Th·ªùi gian h·∫øt h·∫°n cho guest cart
  lastActiveAt DateTime  @default(now()) @map("last_active_at")

  // 
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 
  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@unique([userId])
  @@index([userId])
  @@index([sessionId])
  @@index([expiresAt])
  @@index([lastActiveAt])
  @@map("carts")
}

model CartItem {
  id               String @id @default(uuid())
  cartId           String @map("cart_id")
  productId        String @map("product_id")
  productVariantId String @map("product_variant_id")
  quantity         Int    @default(1)

  // Snapshot
  unitPrice  Decimal @map("unit_price") @db.Decimal(15, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(15, 2)

  // snapshot (ƒë·ªÉ hi·ªÉn th·ªã khi s·∫£n ph·∫©m x√≥a)
  productName     String  @map("product_name")
  variantName     String? @map("variant_name")
  productImageUrl String? @map("product_image_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 
  cart           Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  @@unique([cartId, productVariantId]) // Kh√¥ng cho tr√πng variant
  @@index([cartId])
  @@index([productId])
  @@index([productVariantId])
  @@index([createdAt])
  @@map("cart_items")
}

//Order management

enum OrderStatus {
  PENDING // Ch·ªù x√°c nh·∫≠n
  CONFIRMED // ƒê√£ x√°c nh·∫≠n
  PROCESSING // ƒêang x·ª≠ l√Ω
  SHIPPING // ƒêang giao
  DELIVERED // ƒê√£ giao
  COMPLETED // Ho√†n th√†nh
  CANCELLED // ƒê√£ h·ªßy
  REFUNDED // ƒê√£ ho√†n ti·ªÅn
}

enum PaymentMethod {
  COD // Thanh to√°n khi nh·∫≠n h√†ng
  BANK_TRANSFER // Chuy·ªÉn kho·∫£n
  E_WALLET // V√≠ ƒëi·ªán t·ª≠
  CREDIT_CARD // Th·∫ª t√≠n d·ª•ng
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  SAME_DAY
}

model Order {
  id          String @id @default(uuid())
  orderNumber String @unique @map("order_number") // M√£ ƒë∆°n h√†ng
  userId      String @map("user_id")
  shopId      String @map("shop_id")

  // Tr·∫°ng th√°i
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Gi√° tr·ªã ƒë∆°n h√†ng
  subtotal    Decimal @db.Decimal(15, 2) // T·ªïng ti·ªÅn h√†ng
  shippingFee Decimal @default(0) @map("shipping_fee") @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(10, 2)
  totalAmount Decimal @map("total_amount") @db.Decimal(15, 2)

  // Th√¥ng tin giao h√†ng
  shippingMethod  ShippingMethod @map("shipping_method")
  shippingAddress String         @map("shipping_address")
  recipientName   String         @map("recipient_name")
  recipientPhone  String         @map("recipient_phone")

  // Thanh to√°n
  paymentMethod PaymentMethod @map("payment_method")
  paidAt        DateTime?     @map("paid_at")

  // Ghi ch√∫
  customerNote String? @map("customer_note")
  shopNote     String? @map("shop_note")
  cancelReason String? @map("cancel_reason")

  // Th·ªùi gian
  confirmedAt DateTime? @map("confirmed_at")
  shippedAt   DateTime? @map("shipped_at")
  deliveredAt DateTime? @map("delivered_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Voucher
  voucherId String? @map("voucher_id")

  // Relations
  user          User                 @relation(fields: [userId], references: [id])
  shop          Shop                 @relation(fields: [shopId], references: [id])
  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  payments      Payment[] // üëà Th√™m d√≤ng n√†y
  cashbacks     Cashback[]
  voucher       Voucher?             @relation(fields: [voucherId], references: [id])
  voucherUsages VoucherUsage[]

  @@index([orderNumber])
  @@index([userId])
  @@index([shopId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id               String @id @default(uuid())
  orderId          String @map("order_id")
  productId        String @map("product_id")
  productVariantId String @map("product_variant_id")

  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(15, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(15, 2)

  // Snapshot ƒë·ªÉ l∆∞u th√¥ng tin s·∫£n ph·∫©m t·∫°i th·ªùi ƒëi·ªÉm ƒë·∫∑t
  productName     String  @map("product_name")
  variantName     String? @map("variant_name")
  productImageUrl String? @map("product_image_url")
  sku             String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id])
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productVariantId])
  @@map("order_items")
}

model OrderStatusHistory {
  id         String       @id @default(uuid())
  orderId    String       @map("order_id")
  fromStatus OrderStatus? @map("from_status")
  toStatus   OrderStatus  @map("to_status")
  note       String?
  changedBy  String?      @map("changed_by") // User ID
  changedAt  DateTime     @default(now()) @map("changed_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([changedAt])
  @@map("order_status_history")
}

// payment
model Payment {
  id      String @id @default(uuid())
  orderId String @map("order_id")

  // Th√¥ng tin thanh to√°n
  amount   Decimal       @db.Decimal(15, 2)
  currency String        @default("VND")
  method   PaymentMethod
  status   PaymentStatus @default(PENDING)

  // Th√¥ng tin giao d·ªãch v·ªõi payment gateway
  transactionId   String? @unique @map("transaction_id") // ID t·ª´ payment gateway
  gatewayResponse Json?   @map("gateway_response") // Response t·ª´ gateway

  // Th·ªùi gian
  paidAt    DateTime? @map("paid_at")
  expiredAt DateTime? @map("expired_at")
  failedAt  DateTime? @map("failed_at")

  // Ghi ch√∫
  failureReason String? @map("failure_reason")
  note          String?

  // Auditable
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  cashback Cashback? // 1-1 relation v·ªõi cashback

  @@index([orderId])
  @@index([transactionId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
  @@map("payments")
}

//cash back
enum CashbackStatus {
  PENDING // Ch·ªù x·ª≠ l√Ω
  PROCESSING // ƒêang g·ª≠i l√™n blockchain
  COMPLETED // ƒê√£ ho√†n th√†nh
  FAILED // Th·∫•t b·∫°i
  CANCELLED // ƒê√£ h·ªßy
}

// Blockchain enums
enum BlockchainNetworkType {
  BSC_TESTNET
  BSC_MAINNET
  ETHEREUM_SEPOLIA
  ETHEREUM_MAINNET
  POLYGON_MUMBAI
  POLYGON_MAINNET
}

enum SmartContractType {
  CASHBACK_TOKEN
  CASHBACK_MANAGER
  CASHBACK_POOL
}

enum BlockchainTransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  DROPPED
}

model Cashback {
  id        String @id @default(uuid())
  paymentId String @unique @map("payment_id")
  userId    String @map("user_id")
  orderId   String @map("order_id")

  // Th√¥ng tin cashback
  amount     Decimal        @db.Decimal(15, 2)
  percentage Decimal        @db.Decimal(5, 2) // VD: 5.00 = 5%
  currency   String         @default("VND")
  status     CashbackStatus @default(PENDING)

  // Blockchain info
  blockchainNetwork String?  @map("blockchain_network") // ETH, BSC, Polygon, etc.
  walletAddress     String   @map("wallet_address") // ƒê·ªãa ch·ªâ v√≠ nh·∫≠n cashback
  txHash            String?  @unique @map("tx_hash") // Transaction hash
  blockNumber       Int?     @map("block_number")
  gasUsed           String?  @map("gas_used")
  gasFee            Decimal? @map("gas_fee") @db.Decimal(15, 8)

  // Th·ªùi gian
  eligibleAt  DateTime? @map("eligible_at") // Th·ªùi ƒëi·ªÉm ƒë·ªß ƒëi·ªÅu ki·ªán nh·∫≠n
  processedAt DateTime? @map("processed_at")
  completedAt DateTime? @map("completed_at")
  failedAt    DateTime? @map("failed_at")
  expiresAt   DateTime? @map("expires_at") // H·∫øt h·∫°n claim

  // X·ª≠ l√Ω l·ªói
  failureReason String?   @map("failure_reason")
  retryCount    Int       @default(0) @map("retry_count")
  lastRetryAt   DateTime? @map("last_retry_at")

  // Metadata
  metadata Json? // Th√¥ng tin b·ªï sung
  note     String?

  // Auditable
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@index([paymentId])
  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([walletAddress])
  @@index([txHash])
  @@index([blockchainNetwork])
  @@index([eligibleAt])
  @@index([createdAt])
  @@map("cashbacks")
}

// Blockchain Integration Models

// Blockchain Network Configuration
model BlockchainNetwork {
  id          String                @id @default(uuid())
  name        String                @unique
  type        BlockchainNetworkType
  rpcUrl      String                @map("rpc_url")
  chainId     BigInt                @map("chain_id")
  nativeToken String                @map("native_token") // ETH, BNB, MATIC
  explorerUrl String?               @map("explorer_url")
  isActive    Boolean               @default(true) @map("is_active")

  // Network specific settings
  gasLimit     BigInt? @map("gas_limit")
  gasPrice     BigInt? @map("gas_price")
  maxFeePerGas BigInt? @map("max_fee_per_gas")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relations
  contracts    SmartContract[]
  transactions BlockchainTransaction[]
  events       BlockchainEvent[]

  @@index([type])
  @@index([chainId])
  @@index([isActive])
  @@index([createdAt])
  @@map("blockchain_networks")
}

// Smart Contract Deployments
model SmartContract {
  id               String            @id @default(uuid())
  name             String
  type             SmartContractType
  networkId        String            @map("network_id")
  address          String
  abi              Json // Contract ABI
  bytecode         String? // Contract bytecode
  deploymentTxHash String?           @unique @map("deployment_tx_hash")
  deployerAddress  String            @map("deployer_address")

  // Contract information
  version    String    @default("1.0.0")
  sourceUrl  String?   @map("source_url")
  verified   Boolean   @default(false)
  verifiedAt DateTime? @map("verified_at")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relations
  network      BlockchainNetwork       @relation(fields: [networkId], references: [id], onDelete: Cascade)
  transactions BlockchainTransaction[]
  events       BlockchainEvent[]

  @@unique([networkId, address])
  @@index([networkId])
  @@index([type])
  @@index([address])
  @@index([verified])
  @@index([isActive])
  @@index([createdAt])
  @@map("smart_contracts")
}

// Blockchain Transactions
model BlockchainTransaction {
  id         String  @id @default(uuid())
  txHash     String  @unique @map("tx_hash")
  networkId  String  @map("network_id")
  contractId String? @map("contract_id")

  // Transaction details
  fromAddress String   @map("from_address")
  toAddress   String   @map("to_address")
  value       String // Wei amount
  data        String? // Transaction data
  gasUsed     BigInt?  @map("gas_used")
  gasPrice    BigInt?  @map("gas_price")
  gasFee      Decimal? @map("gas_fee") @db.Decimal(20, 8)

  // Status
  status        BlockchainTransactionStatus @default(PENDING)
  blockNumber   BigInt?                     @map("block_number")
  blockHash     String?                     @map("block_hash")
  confirmations Int                         @default(0)

  // Timing
  sentAt      DateTime  @default(now()) @map("sent_at")
  confirmedAt DateTime? @map("confirmed_at")
  failedAt    DateTime? @map("failed_at")

  // Error handling
  errorMessage String?   @map("error_message")
  retryCount   Int       @default(0) @map("retry_count")
  lastRetryAt  DateTime? @map("last_retry_at")

  // Metadata
  metadata Json?
  note     String?

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  network  BlockchainNetwork @relation(fields: [networkId], references: [id], onDelete: Cascade)
  contract SmartContract?    @relation(fields: [contractId], references: [id], onDelete: SetNull)

  @@index([networkId])
  @@index([contractId])
  @@index([txHash])
  @@index([status])
  @@index([fromAddress])
  @@index([toAddress])
  @@index([blockNumber])
  @@index([sentAt])
  @@index([confirmedAt])
  @@index([createdAt])
  @@map("blockchain_transactions")
}

// Blockchain Events
model BlockchainEvent {
  id         String @id @default(uuid())
  networkId  String @map("network_id")
  contractId String @map("contract_id")

  // Event details
  eventName       String @map("event_name")
  logIndex        Int    @map("log_index")
  transactionHash String @map("transaction_hash")
  blockNumber     BigInt @map("block_number")
  blockHash       String @map("block_hash")

  // Event data
  eventData Json  @map("event_data") // Decoded event parameters
  rawLog    Json? @map("raw_log")

  // Processing
  processed       Boolean   @default(false)
  processedAt     DateTime? @map("processed_at")
  processingError String?   @map("processing_error")

  // Metadata
  metadata Json?

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  network  BlockchainNetwork @relation(fields: [networkId], references: [id], onDelete: Cascade)
  contract SmartContract     @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([transactionHash, logIndex])
  @@index([networkId])
  @@index([contractId])
  @@index([eventName])
  @@index([blockNumber])
  @@index([processed])
  @@index([createdAt])
  @@map("blockchain_events")
}

// Cashback Claims
model CashbackClaim {
  id         String @id @default(uuid())
  cashbackId String @unique @map("cashback_id")
  userId     String @map("user_id")

  // Claim information
  amount          Decimal  @db.Decimal(15, 2)
  claimedAt       DateTime @default(now()) @map("claimed_at")
  validityExpires DateTime @map("validity_expires")

  // Blockchain details
  networkId     String? @map("network_id")
  walletAddress String  @map("wallet_address")
  txHash        String? @unique @map("tx_hash")

  // Status
  status        CashbackStatus @default(PENDING)
  claimedTxHash String?        @unique @map("claimed_tx_hash")

  // Tracking
  processedAt   DateTime? @map("processed_at")
  completedAt   DateTime? @map("completed_at")
  failedAt      DateTime? @map("failed_at")
  failureReason String?   @map("failure_reason")

  // Retry logic
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  lastRetryAt DateTime? @map("last_retry_at")

  // Metadata
  metadata Json?
  note     String?

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([walletAddress])
  @@index([claimedAt])
  @@index([createdAt])
  @@map("cashback_claims")
}

// Chat Support System
enum ConversationType {
  CUSTOMER_SUPPORT // Kh√°ch h√†ng chat v·ªõi shop
  SHOP_TO_CUSTOMER // Shop chat v·ªõi kh√°ch
  ADMIN_SUPPORT // Admin h·ªó tr·ª£
}

enum ConversationStatus {
  ACTIVE // ƒêang ho·∫°t ƒë·ªông
  WAITING // Ch·ªù ph·∫£n h·ªìi
  RESOLVED // ƒê√£ gi·∫£i quy·∫øt
  CLOSED // ƒê√£ ƒë√≥ng
}

enum MessageType {
  TEXT // Tin nh·∫Øn vƒÉn b·∫£n
  IMAGE // H√¨nh ·∫£nh
  FILE // File ƒë√≠nh k√®m
  SYSTEM // Th√¥ng b√°o h·ªá th·ªëng
  ORDER // Th√¥ng tin ƒë∆°n h√†ng
  PRODUCT // Th√¥ng tin s·∫£n ph·∫©m
}

enum MessageStatus {
  SENT // ƒê√£ g·ª≠i
  DELIVERED // ƒê√£ nh·∫≠n
  READ // ƒê√£ ƒë·ªçc
  FAILED // G·ª≠i th·∫•t b·∫°i
}

enum ParticipantRole {
  CUSTOMER // Kh√°ch h√†ng
  SHOP_OWNER // Ch·ªß shop
  ADMIN // Qu·∫£n tr·ªã vi√™n
  SYSTEM // H·ªá th·ªëng
}

// Cu·ªôc h·ªôi tho·∫°i
model Conversation {
  id     String             @id @default(uuid())
  type   ConversationType   @default(CUSTOMER_SUPPORT)
  status ConversationStatus @default(ACTIVE)

  // Li√™n quan ƒë·∫øn shop (n·∫øu c√≥)
  shopId String? @map("shop_id")

  // Ti√™u ƒë·ªÅ v√† m√¥ t·∫£
  title   String? // Ti√™u ƒë·ªÅ cu·ªôc tr√≤ chuy·ªán
  subject String? // Ch·ªß ƒë·ªÅ (order issue, product question, etc.)

  // Metadata
  lastMessageAt   DateTime? @map("last_message_at")
  lastMessageText String?   @map("last_message_text")

  // Tracking
  totalMessages Int @default(0) @map("total_messages")
  unreadCount   Int @default(0) @map("unread_count") // S·ªë tin ch∆∞a ƒë·ªçc

  // Priority
  priority Int @default(0) // 0: normal, 1: high, 2: urgent

  // Tags for filtering
  tags String[] @default([])

  // Timestamps
  resolvedAt DateTime? @map("resolved_at")
  closedAt   DateTime? @map("closed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  shop         Shop?                     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  participants ConversationParticipant[]
  messages     Message[]

  @@index([shopId])
  @@index([type])
  @@index([status])
  @@index([lastMessageAt])
  @@index([priority])
  @@index([createdAt])
  @@map("conversations")
}

// Ng∆∞·ªùi tham gia cu·ªôc h·ªôi tho·∫°i
model ConversationParticipant {
  id             String          @id @default(uuid())
  conversationId String          @map("conversation_id")
  userId         String          @map("user_id")
  role           ParticipantRole @default(CUSTOMER)

  // Tracking
  joinedAt    DateTime  @default(now()) @map("joined_at")
  leftAt      DateTime? @map("left_at")
  lastReadAt  DateTime? @map("last_read_at")
  unreadCount Int       @default(0) @map("unread_count")

  // Settings
  isMuted  Boolean @default(false) @map("is_muted")
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("conversation_participants")
}

// Tin nh·∫Øn
model Message {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")
  senderId       String @map("sender_id")

  // N·ªôi dung
  type    MessageType   @default(TEXT)
  content String        @db.Text // N·ªôi dung tin nh·∫Øn
  status  MessageStatus @default(SENT)

  // File attachments (n·∫øu c√≥)
  attachments Json? // Array of {url, type, name, size}

  // Reference to order or product
  orderId   String? @map("order_id")
  productId String? @map("product_id")

  // Metadata
  metadata Json? // Th√¥ng tin b·ªï sung

  // Reply to another message
  replyToId String? @map("reply_to_id")

  // Timestamps
  sentAt      DateTime  @default(now()) @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  readAt      DateTime? @map("read_at")
  editedAt    DateTime? @map("edited_at")
  deletedAt   DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  replyTo      Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies      Message[]    @relation("MessageReplies")

  @@index([conversationId])
  @@index([senderId])
  @@index([type])
  @@index([status])
  @@index([orderId])
  @@index([productId])
  @@index([sentAt])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("messages")
}

// Voucher
enum VoucherType {
  PERCENTAGE // Gi·∫£m theo ph·∫ßn trƒÉm (VD: 10%)
  FIXED_AMOUNT // Gi·∫£m s·ªë ti·ªÅn c·ªë ƒë·ªãnh (VD: 50,000 VND)
  FREE_SHIPPING // Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn
}

// Enum cho tr·∫°ng th√°i voucher
enum VoucherStatus {
  ACTIVE // ƒêang ho·∫°t ƒë·ªông
  INACTIVE // T·∫°m ng∆∞ng
  EXPIRED // H·∫øt h·∫°n
  DEPLETED // ƒê√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng
}

// Enum cho ph·∫°m vi √°p d·ª•ng
enum VoucherScope {
  ALL // √Åp d·ª•ng cho t·∫•t c·∫£
  SHOP // Ch·ªâ √°p d·ª•ng cho shop c·ª• th·ªÉ
  CATEGORY // √Åp d·ª•ng cho danh m·ª•c
  PRODUCT // √Åp d·ª•ng cho s·∫£n ph·∫©m c·ª• th·ªÉ
}

model Voucher {
  id          String  @id @default(uuid())
  code        String  @unique // M√£ voucher (VD: SUMMER2024)
  name        String // T√™n voucher
  description String? @db.Text

  // Lo·∫°i v√† gi√° tr·ªã gi·∫£m
  type          VoucherType
  discountValue Decimal     @map("discount_value") @db.Decimal(15, 2) // Gi√° tr·ªã (% ho·∫∑c s·ªë ti·ªÅn)
  maxDiscount   Decimal?    @map("max_discount") @db.Decimal(15, 2) // Gi·∫£m t·ªëi ƒëa (cho PERCENTAGE)

  // ƒêi·ªÅu ki·ªán √°p d·ª•ng
  minOrderValue Decimal?     @map("min_order_value") @db.Decimal(15, 2) // Gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu
  scope         VoucherScope @default(ALL)

  // Shop (n·∫øu l√† voucher c·ªßa shop)
  shopId String? @map("shop_id")

  // S·ªë l∆∞·ª£ng v√† gi·ªõi h·∫°n
  totalLimit   Int? @map("total_limit") // T·ªïng s·ªë l∆∞·ª£t s·ª≠ d·ª•ng
  usedCount    Int  @default(0) @map("used_count") // ƒê√£ s·ª≠ d·ª•ng
  limitPerUser Int? @map("limit_per_user") // Gi·ªõi h·∫°n m·ªói user

  // Th·ªùi gian hi·ªáu l·ª±c
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // Tr·∫°ng th√°i
  status   VoucherStatus @default(ACTIVE)
  isPublic Boolean       @default(true) @map("is_public") // Public hay private

  // Auditable fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  shop          Shop?          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  orders        Order[] // Orders ƒë√£ s·ª≠ d·ª•ng voucher n√†y
  voucherUsages VoucherUsage[]

  @@index([code])
  @@index([shopId])
  @@index([status])
  @@index([scope])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("vouchers")
}

model VoucherUsage {
  id        String  @id @default(uuid())
  voucherId String  @map("voucher_id")
  userId    String  @map("user_id")
  orderId   String? @map("order_id") // Null n·∫øu order b·ªã h·ªßy

  discountAmount Decimal @map("discount_amount") @db.Decimal(15, 2) // S·ªë ti·ªÅn ƒë√£ gi·∫£m

  usedAt DateTime @default(now()) @map("used_at")

  // Relations
  voucher    Voucher   @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id])
  order      Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  userRole   UserRole? @relation(fields: [userRoleId], references: [id])
  userRoleId String?

  @@index([voucherId])
  @@index([userId])
  @@index([orderId])
  @@index([usedAt])
  @@map("voucher_usages")
}
