# ğŸ“Š CHAT REALTIME - FLOW DIAGRAMS

## 1. ğŸ”Œ CONNECTION FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚                              â”‚  Socket Server   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                               â”‚
       â”‚  1. socket.io-client.connect(token)          â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                               â”‚
       â”‚  2. Socket created, emit handshake auth      â”‚
       â”‚                                               â”‚
       â”‚  3. Server receives connection request        â”‚
       â”‚                                               â”‚
       â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                              â”‚ socketAuthMiddleware  â”‚
       â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â”‚
       â”‚                              1. Get token tá»« auth/query/header
       â”‚                              2. Verify JWT
       â”‚                              3. Load user tá»« DB
       â”‚                              4. socket.user = user info
       â”‚                                          â”‚
       â”‚  4. Authenticate OK / FAIL               â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                          â”‚
       â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                              â”‚ ChatHandler           â”‚
       â”‚                              â”‚ .handleConnection()   â”‚
       â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â”‚
       â”‚                              1. socket.join(user room)
       â”‚                              2. Emit USER_ONLINE
       â”‚                              3. Register events
       â”‚                                          â”‚
       â”‚  5. Connected âœ…                        â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                          â”‚
       â”‚  6. socket.on listeners registered      â”‚
       â”‚      - NEW_MESSAGE                      â”‚
       â”‚      - USER_TYPING                      â”‚
       â”‚      - etc...                           â”‚
       â”‚                                          â”‚
```

---

## 2. ğŸ’¬ SEND MESSAGE FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client 1  â”‚                    â”‚   Server     â”‚               â”‚    Client 2  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚                             â”‚
       â”‚  1. User types message            â”‚                             â”‚
       â”‚     "Hello, how are you?"         â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚  2. socket.emit('chat:send_msg')  â”‚                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚       {                           â”‚                             â”‚
       â”‚         conversationId,           â”‚                             â”‚
       â”‚         content,                  â”‚                             â”‚
       â”‚         type                      â”‚                             â”‚
       â”‚       }                           â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
       â”‚                    â”‚ ChatHandler              â”‚                â”‚
       â”‚                    â”‚ .handleSendMessage()     â”‚                â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                    1. Verify user is in DB                    â”‚
       â”‚                    2. Verify user is participant              â”‚
       â”‚                    3. Verify conversation not closed          â”‚
       â”‚                    4. Save message to DB                      â”‚
       â”‚                    5. Update conversation                     â”‚
       â”‚                       - lastMessage                           â”‚
       â”‚                       - messageCount++                        â”‚
       â”‚                    6. Increment unread for others             â”‚
       â”‚                             â”‚                                 â”‚
       â”‚  3. Callback { success, msg }  â”‚                             â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
       â”‚                              â”‚                                 â”‚
       â”‚  4. Display msg locally      â”‚                                 â”‚
       â”‚     (optimistic update)      â”‚                                 â”‚
       â”‚                              â”‚                                 â”‚
       â”‚                    7. io.to(conversation room)               â”‚
       â”‚                       .emit('chat:new_message')              â”‚
       â”‚                              â”‚                                 â”‚
       â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                              â”‚   NEW_MESSAGE event with msg   â”‚
       â”‚                              â”‚                                 â”‚
       â”‚                              â”‚   5. Display message           â”‚
       â”‚                              â”‚   6. Show sender info          â”‚
       â”‚                              â”‚   (notification if minimized)  â”‚
       â”‚                              â”‚                                 â”‚
```

---

## 3. ğŸ“– MARK AS READ FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client 1  â”‚                    â”‚   Server     â”‚               â”‚    Client 2  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚                             â”‚
       â”‚  1. User scrolls to bottom        â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚  2. socket.emit(                 â”‚                             â”‚
       â”‚     'chat:mark_as_read',         â”‚                             â”‚
       â”‚     { conversationId }           â”‚                             â”‚
       â”‚    )                             â”‚                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                  â”‚                             â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
       â”‚                    â”‚ ChatHandler             â”‚                â”‚
       â”‚                    â”‚ .handleMarkAsRead()     â”‚                â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                    1. Get conversation + participants         â”‚
       â”‚                    2. Verify user is participant              â”‚
       â”‚                    3. Mark all user's messages as read        â”‚
       â”‚                       - messages.isRead = true                â”‚
       â”‚                    4. Update unreadCount = 0                  â”‚
       â”‚                    5. Update lastReadAt = now()              â”‚
       â”‚                             â”‚                                 â”‚
       â”‚  3. Callback { success }   â”‚                                 â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                    â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                    6. socket.to(conversation)               â”‚
       â”‚                       .emit('chat:message_read')            â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                          â”‚   MESSAGE_READ event             â”‚
       â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                          â”‚                                    â”‚
       â”‚                          â”‚   Update UI:                      â”‚
       â”‚                          â”‚   - Remove unread badge           â”‚
       â”‚                          â”‚   - Show "2 people read"          â”‚
       â”‚                          â”‚   - Update read receipt time      â”‚
       â”‚                          â”‚                                    â”‚
```

---

## 4. âŒ¨ï¸ TYPING INDICATOR FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client 1  â”‚                    â”‚   Server     â”‚               â”‚    Client 2  â”‚
â”‚   (typing)   â”‚                    â”‚   (relay)    â”‚               â”‚ (watching)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚                             â”‚
       â”‚  1. User types first char        â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚  2. socket.emit(                 â”‚                             â”‚
       â”‚     'chat:typing_start',         â”‚                             â”‚
       â”‚     { conversationId }           â”‚                             â”‚
       â”‚    )                             â”‚                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                  â”‚                             â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
       â”‚                    â”‚ handleTypingStart()  â”‚                   â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                    socket.to(conversation)                   â”‚
       â”‚                    .emit('chat:user_typing',                â”‚
       â”‚                       {                                      â”‚
       â”‚                         conversationId,                      â”‚
       â”‚                         user: {                              â”‚
       â”‚                           id, firstName, lastName            â”‚
       â”‚                         }                                    â”‚
       â”‚                       }                                      â”‚
       â”‚                    )                                         â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                             â”‚  USER_TYPING                  â”‚
       â”‚                             â”‚                                â”‚
       â”‚                             â”‚  Show:                        â”‚
       â”‚                             â”‚  "John is typing..."          â”‚
       â”‚                             â”‚  (with animation)             â”‚
       â”‚                             â”‚                                â”‚
       â”‚  3. User types more...      â”‚                                â”‚
       â”‚  (NOT sending typing event again - debounced)               â”‚
       â”‚                                                              â”‚
       â”‚  (2 seconds passed, no more input)                          â”‚
       â”‚                                                              â”‚
       â”‚  4. socket.emit(                                             â”‚
       â”‚     'chat:typing_stop',                                      â”‚
       â”‚     { conversationId }                                       â”‚
       â”‚    )                                                         â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                  â”‚                             â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
       â”‚                    â”‚ handleTypingStop()   â”‚                   â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                    socket.to(conversation)                   â”‚
       â”‚                    .emit('chat:user_stopped_typing',        â”‚
       â”‚                       {                                      â”‚
       â”‚                         conversationId,                      â”‚
       â”‚                         userId                               â”‚
       â”‚                       }                                      â”‚
       â”‚                    )                                         â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                             â”‚  USER_STOPPED_TYPING          â”‚
       â”‚                             â”‚                                â”‚
       â”‚                             â”‚  Hide typing indicator         â”‚
       â”‚                             â”‚                                â”‚
```

---

## 5. ğŸ¯ JOIN CONVERSATION FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client    â”‚                    â”‚   Socket Server  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                     â”‚
       â”‚  1. User clicks conversation       â”‚
       â”‚                                     â”‚
       â”‚  2. socket.emit(                   â”‚
       â”‚     'chat:join_conversation',      â”‚
       â”‚     { conversationId }             â”‚
       â”‚    )                               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                     â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚ handleJoinConversation â”‚
       â”‚                    â”‚ .handleJoinConv()      â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
       â”‚                    1. Verify access rights
       â”‚                    2. socket.join(
       â”‚                         `conversation:${id}`
       â”‚                       )
       â”‚                    3. Load initial messages
       â”‚                               â”‚
       â”‚  3. Callback { success, msgs} â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                              â”‚
       â”‚  4. Display conversation:    â”‚
       â”‚     - Messages               â”‚
       â”‚     - Participants           â”‚
       â”‚     - Unread count = 0       â”‚
       â”‚                              â”‚
       â”‚  5. Auto-mark as read        â”‚
       â”‚                              â”‚
       â”‚  6. Now listening to:        â”‚
       â”‚     - NEW_MESSAGE            â”‚
       â”‚     - MESSAGE_UPDATED        â”‚
       â”‚     - MESSAGE_DELETED        â”‚
       â”‚     - USER_TYPING            â”‚
       â”‚     - etc...                 â”‚
       â”‚                              â”‚
```

---

## 6. ğŸ—‘ï¸ DELETE MESSAGE FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client 1  â”‚                    â”‚   Server     â”‚               â”‚    Client 2  â”‚
â”‚  (msg owner) â”‚                    â”‚              â”‚               â”‚  (recipient) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚                             â”‚
       â”‚  1. User clicks delete            â”‚                             â”‚
       â”‚     on their own message          â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚  2. socket.emit(                 â”‚                             â”‚
       â”‚     'chat:delete_message',       â”‚                             â”‚
       â”‚     { messageId }                â”‚                             â”‚
       â”‚    )                             â”‚                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                  â”‚                             â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
       â”‚                    â”‚ handleDeleteMessage()â”‚                   â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                    1. Get message from DB                    â”‚
       â”‚                    2. Verify senderId === userId             â”‚
       â”‚                    3. Soft delete message                    â”‚
       â”‚                       (set deletedAt = now)                  â”‚
       â”‚                             â”‚                                 â”‚
       â”‚  3. Callback { success }   â”‚                                 â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                    â”‚
       â”‚                          â”‚                                    â”‚
       â”‚  4. Remove from UI       â”‚                                    â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                    4. io.to(conversation)                   â”‚
       â”‚                       .emit('chat:message_deleted',         â”‚
       â”‚                         {                                    â”‚
       â”‚                           messageId,                         â”‚
       â”‚                           conversationId                     â”‚
       â”‚                         }                                    â”‚
       â”‚                       )                                      â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                          â”‚  MESSAGE_DELETED event           â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                          â”‚  Remove message from UI           â”‚
       â”‚                          â”‚  (or show "[Message deleted]")    â”‚
       â”‚                          â”‚                                    â”‚
```

---

## 7. ğŸ“ EDIT MESSAGE FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client 1  â”‚                    â”‚   Server     â”‚               â”‚    Client 2  â”‚
â”‚  (msg owner) â”‚                    â”‚              â”‚               â”‚  (recipient) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚                             â”‚
       â”‚  1. User clicks edit              â”‚                             â”‚
       â”‚     Opens modal with old text     â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚  2. User modifies text            â”‚                             â”‚
       â”‚     "Hello" â†’ "Hi there!"         â”‚                             â”‚
       â”‚                                   â”‚                             â”‚
       â”‚  3. socket.emit(                 â”‚                             â”‚
       â”‚     'chat:edit_message',          â”‚                             â”‚
       â”‚     {                             â”‚                             â”‚
       â”‚       messageId,                  â”‚                             â”‚
       â”‚       content: 'Hi there!'        â”‚                             â”‚
       â”‚     }                             â”‚                             â”‚
       â”‚    )                              â”‚                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                  â”‚                             â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
       â”‚                    â”‚ handleEditMessage() â”‚                    â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
       â”‚                             â”‚                                 â”‚
       â”‚                    1. Get message from DB                    â”‚
       â”‚                    2. Verify senderId === userId             â”‚
       â”‚                    3. Update message:                        â”‚
       â”‚                       - content = 'Hi there!'                â”‚
       â”‚                       - editedAt = now()                     â”‚
       â”‚                    4. Return updated message                 â”‚
       â”‚                             â”‚                                 â”‚
       â”‚  4. Callback { success, msg}â”‚                                 â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                    â”‚
       â”‚                          â”‚                                    â”‚
       â”‚  5. Update local message:â”‚                                    â”‚
       â”‚     - content            â”‚                                    â”‚
       â”‚     - Add "(edited)" tag â”‚                                    â”‚
       â”‚     - editedAt           â”‚                                    â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                    5. io.to(conversation)                   â”‚
       â”‚                       .emit('chat:message_updated',         â”‚
       â”‚                         { updated message }                 â”‚
       â”‚                       )                                      â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                          â”‚  MESSAGE_UPDATED event           â”‚
       â”‚                          â”‚                                    â”‚
       â”‚                          â”‚  Update UI:                       â”‚
       â”‚                          â”‚  - content: 'Hi there!'           â”‚
       â”‚                          â”‚  - Show "(edited)" label          â”‚
       â”‚                          â”‚  - editedAt timestamp             â”‚
       â”‚                          â”‚                                    â”‚
```

---

## 8. ğŸ” AUTHENTICATION FLOW (DETAILED)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client    â”‚                    â”‚   Server     â”‚                  â”‚   DB     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚                               â”‚
       â”‚  1. User logs in / get token      â”‚                               â”‚
       â”‚     localStorage.setItem(         â”‚                               â”‚
       â”‚       'accessToken', token        â”‚                               â”‚
       â”‚     )                             â”‚                               â”‚
       â”‚                                   â”‚                               â”‚
       â”‚  2. socket.io-client.connect()    â”‚                               â”‚
       â”‚     with token in auth:           â”‚                               â”‚
       â”‚     {                             â”‚                               â”‚
       â”‚       auth: {                     â”‚                               â”‚
       â”‚         token: 'eyJhb...'         â”‚                               â”‚
       â”‚       }                           â”‚                               â”‚
       â”‚     }                             â”‚                               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                  â”‚                               â”‚
       â”‚     Server receives connection    â”‚                               â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
       â”‚                    â”‚ socketAuthMiddleware â”‚                      â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                             â”‚                                    â”‚
       â”‚                    1. Extract token from:                       â”‚
       â”‚                       - socket.handshake.auth.token            â”‚
       â”‚                       - socket.handshake.query.token           â”‚
       â”‚                       - socket.handshake.headers.authorization â”‚
       â”‚                             â”‚                                    â”‚
       â”‚                    2. JwtUtils.verifyAccessToken(token)        â”‚
       â”‚                       - Decode JWT                              â”‚
       â”‚                       - Verify signature                        â”‚
       â”‚                       - Check expiration                        â”‚
       â”‚                       - Extract userId                          â”‚
       â”‚                             â”‚                                    â”‚
       â”‚                    3. Query user by ID                         â”‚
       â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                             â”‚  SELECT * FROM users WHERE id = ?
       â”‚                             â”‚                                    â”‚
       â”‚                             â”‚  Return user data:               â”‚
       â”‚                             â”‚  - id, email, firstName,         â”‚
       â”‚                             â”‚  - lastName, status, roles       â”‚
       â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                             â”‚                                    â”‚
       â”‚                    4. Check user.status === 'ACTIVE'           â”‚
       â”‚                       If not: reject connection                 â”‚
       â”‚                             â”‚                                    â”‚
       â”‚                    5. socket.user = {                          â”‚
       â”‚                         id: user.id,                           â”‚
       â”‚                         email: user.email,                     â”‚
       â”‚                         firstName: user.firstName,             â”‚
       â”‚                         lastName: user.lastName,               â”‚
       â”‚                         roles: user.roles.map(...)            â”‚
       â”‚                       }                                         â”‚
       â”‚                             â”‚                                    â”‚
       â”‚  3. Socket authenticated âœ…â”‚                                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
       â”‚                             â”‚                                    â”‚
       â”‚  4. Client ready to emit   â”‚                                    â”‚
       â”‚     events                  â”‚                                    â”‚
       â”‚                             â”‚                                    â”‚
       â”‚  5. Server can access:      â”‚                                    â”‚
       â”‚     socket.user.id          â”‚                                    â”‚
       â”‚     socket.user.email       â”‚                                    â”‚
       â”‚     socket.user.roles       â”‚                                    â”‚
       â”‚                             â”‚                                    â”‚
```

---

## 9. âŒ ERROR HANDLING FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client    â”‚                    â”‚   Server     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚
       â”‚  socket.emit('chat:send_message')â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                                   â”‚
       â”‚                    Handler executes:
       â”‚                    - Validates input
       â”‚                    - Checks permissions
       â”‚                    - Saves to DB
       â”‚                                   â”‚
       â”‚                    âŒ ERROR OCCURS:
       â”‚                    - NotFoundError
       â”‚                    - ForbiddenError
       â”‚                    - ValidationError
       â”‚                    - Database error
       â”‚                                   â”‚
       â”‚                    catch(error) {
       â”‚                      callback({
       â”‚                        success: false,
       â”‚                        error: error.message
       â”‚                      })
       â”‚                    }
       â”‚                                   â”‚
       â”‚  Callback with error             â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                   â”‚
       â”‚  Client handles error:           â”‚
       â”‚  - Show toast/alert              â”‚
       â”‚  - Log to console                â”‚
       â”‚  - Retry logic                   â”‚
       â”‚                                   â”‚
       â”‚  socket.on(CHAT_EVENTS_EMIT.ERROR)
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                   â”‚
       â”‚  Handle generic error event      â”‚
       â”‚                                   â”‚
```

---

## 10. ğŸŒ ROOM STRUCTURE

```
Socket.IO Server
â”‚
â”œâ”€â”€ Room: "user:user1"
â”‚   â”œâ”€â”€ Socket 1 (Browser tab 1)
â”‚   â”œâ”€â”€ Socket 2 (Mobile)
â”‚   â””â”€â”€ Socket 3 (Desktop)
â”‚
â”œâ”€â”€ Room: "user:user2"
â”‚   â””â”€â”€ Socket 4 (Browser tab 1)
â”‚
â”œâ”€â”€ Room: "conversation:conv123"
â”‚   â”œâ”€â”€ user1 (Socket 1, 2, 3 - all tabs/devices)
â”‚   â”œâ”€â”€ user2 (Socket 4)
â”‚   â””â”€â”€ user3 (Socket 5 - shop owner)
â”‚
â””â”€â”€ Room: "conversation:conv456"
    â””â”€â”€ user1, user4, user5
```

**Khi gá»­i message:**
```
io.to(SOCKET_ROOMS.conversation(conversationId))
   .emit(CHAT_EVENTS_EMIT.NEW_MESSAGE, message)

// Gá»­i message tá»›i táº¥t cáº£ participants trong conversation
// Má»—i participant nháº­n trÃªn táº¥t cáº£ devices/tabs cá»§a há»
```

---

## 11. ğŸ“Š STATE CHANGES

```
[Client 1]                        [Server]                      [Client 2]
messages: []                      database: empty               messages: []
â”‚                                 â”‚                             â”‚
â”‚  sendMessage("Hello")           â”‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
â”‚                                 â”‚ Save message                â”‚
â”‚                                 â”œâ”€ Message ID: msg123         â”‚
â”‚                                 â”‚                             â”‚
messages.push(msg123)             â”‚  Broadcast                  â”‚
â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
â”‚                                 â”‚                             â”‚
â”‚                                 â”‚                   messages.push(msg123)
â”‚                                 â”‚                             â”‚
â”‚  callback: âœ…                  â”‚                             â”‚
â”‚                                 â”‚                             â”‚
â”‚  Server: emit('new_message')    â”‚                             â”‚
â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚                                 â”‚                             â”‚
â”‚  [Confirm message received]     â”‚                             â”‚
â”‚                                 â”‚                             â”‚
â”‚                                 â”‚  Client 2 emit('mark_read')â”‚
â”‚                                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚                                 â”‚  Update: isRead = true      â”‚
â”‚                                 â”‚                             â”‚
â”‚  emit('message_read') event     â”‚                             â”‚
â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚  [Show "2 people read"]         â”‚                             â”‚
â”‚                                 â”‚                             â”‚
```

---

## 12. â±ï¸ MESSAGE LIFECYCLE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CREATED   â”‚  message.sentAt = now()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  message.isRead = false
       â”‚
       â”‚  User other than sender sees
       â”œâ”€â”€> UNREAD
       â”‚    unreadCount++
       â”‚
       â”‚  User reads message / scrolls
       â”œâ”€â”€> READ
       â”‚    isRead = true
       â”‚    unreadCount--
       â”‚
       â”‚  User clicks edit
       â”œâ”€â”€> EDITING
       â”‚    (client state only)
       â”‚
       â”‚  Submit edit
       â”œâ”€â”€> EDITED
       â”‚    message.editedAt = now()
       â”‚    message.content = "new content"
       â”‚
       â”‚  User clicks delete
       â”œâ”€â”€> DELETED
       â”‚    message.deletedAt = now()
       â”‚    (soft delete, still in DB)
       â”‚
       â””â”€â”€> ARCHIVED
            (not shown in UI)
            (can be restored from backup)

```

---

**CÃ¡c diagram trÃªn giÃºp báº¡n hiá»ƒu rÃµ luá»“ng xá»­ lÃ½ cá»§a má»—i feature! ğŸ¯**
